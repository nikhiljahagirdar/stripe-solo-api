import { db } from '../db';import { taxRatesTable, type NewTaxRate } from '../db/schema';import { eq, and, sql } from 'drizzle-orm';import { getOrCreateStripeClient } from './client.service';export class TaxRateService {  async create(userId: number, stripeAccountId: number, taxRateData: any): Promise<any> {    const stripe = await getOrCreateStripeClient(stripeAccountId, userId);    if (!stripe) {throw new Error('Stripe client not found');}    const stripeTaxRate = await stripe.taxRates.create(taxRateData);        const newTaxRate: NewTaxRate = {      userId,      stripeAccountId,      stripeTaxRateId: stripeTaxRate.id,      displayName: stripeTaxRate.display_name,      jurisdiction: stripeTaxRate.jurisdiction,      country: stripeTaxRate.country,      state: stripeTaxRate.state,      percentage: stripeTaxRate.percentage.toString(),      inclusive: stripeTaxRate.inclusive,      active: stripeTaxRate.active,    };    const [taxRate] = await db.insert(taxRatesTable).values(newTaxRate).returning();    return taxRate;  }  async findByUser(userId: number, accountId?: number, year?: number): Promise<any[]> {    const conditions = [eq(taxRatesTable.userId, userId)];    if (accountId) {      conditions.push(eq(taxRatesTable.stripeAccountId, accountId));    }    if (year) {      const startDate = new Date(year, 0, 1);      const endDate = new Date(year, 11, 31, 23, 59, 59, 999);      conditions.push(sql`${taxRatesTable.createdAt} >= ${startDate}`);      conditions.push(sql`${taxRatesTable.createdAt} <= ${endDate}`);    }    const rates = await db.select().from(taxRatesTable).where(and(...conditions));    return rates;  }  async findById(userId: number, id: number): Promise<any> {    const [taxRate] = await db.select().from(taxRatesTable)      .where(and(eq(taxRatesTable.id, id), eq(taxRatesTable.userId, userId)))      .limit(1);    return taxRate;  }  async update(userId: number, stripeAccountId: number, id: number, updateData: any): Promise<any> {    const taxRate = await this.findById(userId, id);    if (!taxRate) {return null;}    const stripe = await getOrCreateStripeClient(stripeAccountId, userId);    if (!stripe) {throw new Error('Stripe client not found');}    const updatedTaxRate = await stripe.taxRates.update(taxRate.stripeTaxRateId, updateData);    const [updated] = await db.update(taxRatesTable)      .set({ active: updatedTaxRate.active, updatedAt: new Date() })      .where(and(eq(taxRatesTable.id, id), eq(taxRatesTable.userId, userId)))      .returning();        return updated || null;  }}
import { db } from '../db';import { shippingRatesTable, type NewShippingRate } from '../db/schema';import { eq, and, sql } from 'drizzle-orm';import { getOrCreateStripeClient } from './client.service';export class ShippingRateService {  async create(userId: number, stripeAccountId: number, shippingRateData: any): Promise<any> {    const stripe = await getOrCreateStripeClient(stripeAccountId, userId);    if (!stripe) {throw new Error('Stripe client not found');}    const stripeShippingRate = await stripe.shippingRates.create(shippingRateData);        const newShippingRate: NewShippingRate = {      userId,      stripeAccountId,      stripeShippingRateId: stripeShippingRate.id,      displayName: stripeShippingRate.display_name,      fixedAmount: stripeShippingRate.fixed_amount?.amount ? (stripeShippingRate.fixed_amount.amount / 100).toString() : null,      currency: stripeShippingRate.fixed_amount?.currency,      deliveryEstimate: JSON.stringify(stripeShippingRate.delivery_estimate),      taxBehavior: stripeShippingRate.tax_behavior,      type: stripeShippingRate.type,      active: stripeShippingRate.active,    };    const [shippingRate] = await db.insert(shippingRatesTable).values(newShippingRate).returning();    return shippingRate;  }  async findByUser(userId: number, accountId?: number, year?: number): Promise<any[]> {    const conditions = [eq(shippingRatesTable.userId, userId)];    if (accountId) {      conditions.push(eq(shippingRatesTable.stripeAccountId, accountId));    }    if (year) {      const startDate = new Date(year, 0, 1);      const endDate = new Date(year, 11, 31, 23, 59, 59, 999);      conditions.push(sql`${shippingRatesTable.createdAt} >= ${startDate}`);      conditions.push(sql`${shippingRatesTable.createdAt} <= ${endDate}`);    }    const rates = await db.select().from(shippingRatesTable).where(and(...conditions));    return rates;  }  async findById(userId: number, id: number): Promise<any> {    const [shippingRate] = await db.select().from(shippingRatesTable)      .where(and(eq(shippingRatesTable.id, id), eq(shippingRatesTable.userId, userId)))      .limit(1);    return shippingRate;  }  async update(userId: number, stripeAccountId: number, id: number, updateData: any): Promise<any> {    const shippingRate = await this.findById(userId, id);    if (!shippingRate) {return null;}    const stripe = await getOrCreateStripeClient(stripeAccountId, userId);    if (!stripe) {throw new Error('Stripe client not found');}    const updatedShippingRate = await stripe.shippingRates.update(shippingRate.stripeShippingRateId, updateData);    const [updated] = await db.update(shippingRatesTable)      .set({ active: updatedShippingRate.active, updatedAt: new Date() })      .where(and(eq(shippingRatesTable.id, id), eq(shippingRatesTable.userId, userId)))      .returning();        return updated || null;  }}